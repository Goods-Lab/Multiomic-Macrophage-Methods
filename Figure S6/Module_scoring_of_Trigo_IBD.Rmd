---
title: "Module scoring of Garrido-Trigo_Markers_SingleCell_Clusters"
output: html_notebook
---

```{r}
library(readxl)
library(dplyr)
setwd("Path to nucseq data")
snrna <- readRDS("snRNAseq.rds") 
myeloid <- read_excel("Garrido-Trigo_Markers_SingleCell_Clusters.xlsx", sheet = "Myeloid cells")

macrophage_pops <- c("IDA macrophage", "M0_Ribhi", "M0", "M1 ACOD1", "M1 CXCL5", "M2", "M2.2")

macrophage_df <- myeloid %>%
  filter(Population %in% macrophage_pops)

macrophage_df_filtered <- macrophage_df %>%
  filter(p_val_adj <= 0.05, abs(avg_log2FC) >= 0.25)

```

```{r}
library(dplyr)
library(tidyr)
library(UCell)

macrophage_lists <- macrophage_df_filtered %>%
  group_by(Population) %>%
  summarize(genes = list(unique(gene)), .groups = "drop")

# Convert to a named list for AddModuleScore/UCell
macrophage_gene_lists <- setNames(macrophage_lists$genes, macrophage_lists$Population)


#Calculate module score columns
snrna <- AddModuleScore_UCell(
  snrna,
  features = macrophage_gene_lists,
  name = names(macrophage_gene_lists)
)

# Extract module score columns
score_cols <- grep("^M|macrophage", colnames(snrna@meta.data), value = TRUE)

# Make a tidy data frame for ggplot
score_data <- snrna@meta.data %>%
  select(all_of(score_cols), seurat_clusters) %>%
  pivot_longer(cols = all_of(score_cols), names_to = "Signature", values_to = "Score")
```
```{r}
# ---- packages ----
library(Seurat)
library(dplyr)
library(tidyr)
library(ComplexHeatmap)
library(circlize)
library(ggplot2)

# ---- 1) Combine module scores into single M0/M1/M2 per cell ----
m0_cols <- grep("^M0", colnames(snrna@meta.data), value = TRUE, ignore.case = FALSE)
m1_cols <- grep("^M1", colnames(snrna@meta.data), value = TRUE, ignore.case = FALSE)
m2_cols <- grep("^M2", colnames(snrna@meta.data), value = TRUE, ignore.case = FALSE)

snrna$score_M0 <- if (length(m0_cols)) rowMeans(snrna@meta.data[, m0_cols, drop = FALSE]) else NA_real_
snrna$score_M1 <- if (length(m1_cols)) rowMeans(snrna@meta.data[, m1_cols, drop = FALSE]) else NA_real_
snrna$score_M2 <- if (length(m2_cols)) rowMeans(snrna@meta.data[, m2_cols, drop = FALSE]) else NA_real_

# Optional: assign each cell to the max-scoring class
score_mat <- snrna@meta.data[, c("score_M0","score_M1","score_M2")]
snrna$M_class <- c("M0","M1","M2")[max.col(score_mat, ties.method = "first")]

# ---- 2) HEATMAP: mean combined scores per Seurat cluster ----
# (rows = M0/M1/M2; columns = clusters)
cluster_id <- if ("seurat_clusters" %in% colnames(snrna@meta.data)) snrna$seurat_clusters else Idents(snrna)

mean_by_cluster <- snrna@meta.data %>%
  mutate(cluster = as.factor(cluster_id)) %>%
  group_by(cluster) %>%
  summarize(
    M0 = mean(score_M0, na.rm = TRUE),
    M1 = mean(score_M1, na.rm = TRUE),
    M2 = mean(score_M2, na.rm = TRUE),
    n  = dplyr::n()
  ) %>%
  arrange(as.numeric(as.character(cluster)))

mat <- t(as.matrix(mean_by_cluster[, c("M0","M1","M2")]))
colnames(mat) <- paste0("C", mean_by_cluster$cluster)

# color scale (viridis-ish, colorblind-friendly)
pal_fun <- colorRamp2(c(min(mat, na.rm=TRUE), median(mat, na.rm=TRUE), max(mat, na.rm=TRUE)),
                      c("#F7FBFF", "#74ADD1", "#313695"))

# optional column annotation: cluster sizes
col_ha <- HeatmapAnnotation(
  Cells = anno_barplot(mean_by_cluster$n, gp = gpar(fill = "#999999"), axis_param = list(side = "right"))
)

ht <- Heatmap(mat,
              name = "Mean score",
              col = pal_fun,
              cluster_rows = FALSE,
              cluster_columns = TRUE,
              column_title = "Mean M0/M1/M2 scores per cluster",
              row_title = "Signature",
              top_annotation = col_ha)

draw(ht)

```

